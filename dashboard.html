<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Control de Inventarios Diarios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --sidebar-width: 260px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
        }
        
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #2d3748 0%, #4a5568 100%);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .main-content {
            margin-left: var(--sidebar-width);
            transition: all 0.3s ease;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }
        
        .btn-primary {
            background: var(--primary-gradient);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .input-field {
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .table-row:hover {
            background: #f7fafc;
        }
        
        .scanner-container {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative; /* Added for scanner video */
        }

        .scanner-container video {
            width: 100%;
            height: auto;
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                height: 100vh;
                z-index: 1000;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }
            
            .mobile-overlay.open {
                display: block;
            }
        }
        
        /* Animations */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .nav-item.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-weight: 600;
        }
        
        .nav-item i {
            width: 20px;
            margin-right: 12px;
        }
    </style>
</head>
<body class="flex">
    <!-- Sidebar Navigation -->
    <div class="sidebar fixed top-0 left-0 h-full text-white">
        <div class="p-6">
            <div class="flex items-center justify-between mb-8">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-boxes text-xl"></i>
                    </div>
                    <h1 class="text-xl font-bold">Control de Inventarios</h1>
                </div>
                <button id="closeSidebar" class="lg:hidden text-white/70 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <nav class="space-y-1">
                <a href="#dashboard" class="nav-item active" data-section="dashboard">
                    <i class="fas fa-chart-pie"></i>
                    Dashboard
                </a>
                <a href="#inventario-diario" class="nav-item" data-section="inventario-diario">
                    <i class="fas fa-clipboard-check"></i>
                    Inventario Diario
                </a>
                <a href="#inventario" class="nav-item" data-section="inventario">
                    <i class="fas fa-clipboard-list"></i>
                    Ver Inventario
                </a>
                <a href="#exportar" class="nav-item" data-section="exportar">
                    <i class="fas fa-file-export"></i>
                    Exportar CSV
                </a>
                <a href="#importar-inventario" class="nav-item" data-section="importar-inventario">
                    <i class="fas fa-file-import"></i>
                    Importar Inventario
                </a>
                <a href="#importar-codigos" class="nav-item" data-section="importar-codigos">
                    <i class="fas fa-database"></i>
                    Importar Códigos
                </a>
                <a href="#usuarios" class="nav-item" data-section="usuarios">
                    <i class="fas fa-users-cog"></i>
                    Gestión de Usuarios
                </a>
            </nav>
            
            <div class="absolute bottom-6 left-6 right-6">
                <div class="border-t border-white/20 pt-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-user text-sm"></i>
                            </div>
                            <span id="currentUserName" class="text-sm">Usuario</span>
                        </div>
                        <button id="logoutBtn" class="text-white/70 hover:text-white">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="mobile-overlay"></div>

    <!-- Main Content -->
    <div class="main-content flex-1 min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200 p-4 flex items-center justify-between">
            <button id="menuToggle" class="lg:hidden text-gray-600 hover:text-gray-800">
                <i class="fas fa-bars text-xl"></i>
            </button>
            
            <h2 class="text-xl font-semibold text-gray-800" id="currentSectionTitle">Dashboard</h2>
            
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <button class="text-gray-600 hover:text-gray-800">
                        <i class="fas fa-bell"></i>
                    </button>
                    <span class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full"></span>
                </div>
            </div>
        </header>

        <!-- Content Sections -->
        <main class="p-6 space-y-6">
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="section-content">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Total Artículos</p>
                                <h3 class="text-2xl font-bold text-gray-800" id="totalArticulos">0</h3>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-box text-blue-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Unidades Totales</p>
                                <h3 class="text-2xl font-bold text-gray-800" id="totalUnidadesDashboard">0</h3>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-cubes text-green-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Proveedores</p>
                                <h3 class="text-2xl font-bold text-gray-800" id="totalProveedores">0</h3>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-truck text-purple-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Última Actualización</p>
                                <h3 class="text-xl font-bold text-gray-800" id="ultimaActualizacion">-</h3>
                            </div>
                            <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-sync text-orange-600"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Artículos Recientes</h3>
                        <div class="space-y-3" id="recentItems">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-inbox text-3xl mb-2"></i>
                                <p>No hay artículos recientes</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Distribución por Proveedor</h3>
                        <div id="proveedorChart" class="h-64 flex items-center justify-center">
                            <div class="text-center text-gray-500">
                                <i class="fas fa-chart-pie text-3xl mb-2"></i>
                                <p>No hay datos disponibles</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Inventario Diario Section (Unified Agregar Artículo and Escanear Códigos) -->
            <section id="inventario-diario-section" class="section-content hidden">
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-6">Registro de Inventario Diario</h3>
                    
                    <form id="articuloForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fecha *</label>
                            <input type="date" id="fechaInventario" 
                                   class="input-field w-full px-4 py-3 rounded-lg" 
                                   required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Código del Artículo *</label>
                            <input type="text" id="codigoArticulo" 
                                   class="input-field w-full px-4 py-3 rounded-lg" 
                                   placeholder="Ingrese el código o escanee"
                                   required
                                   onchange="cargarDatosArticulo(this.value)">
                        </div>
                        
                        <div class="md:col-span-2">
                            <button type="button" id="startScannerBtn" class="btn-primary w-full py-3 rounded-lg text-white">
                                <i class="fas fa-barcode mr-2"></i>
                                Escanear Código (Barras/QR)
                            </button>
                        </div>

                        <div id="scanner-area" class="md:col-span-2 hidden">
                            <div class="scanner-container mb-4 rounded-lg overflow-hidden">
                                <div id="scanner" class="w-full h-64 bg-gray-200 flex items-center justify-center">
                                    <div class="text-center text-gray-600">
                                        <i class="fas fa-camera text-3xl mb-2"></i>
                                        <p>Iniciando cámara...</p>
                                    </div>
                                </div>
                            </div>
                            <button type="button" id="stopScannerBtn" class="w-full py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                                <i class="fas fa-stop mr-2"></i>
                                Detener Escáner
                            </button>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Proveedor</label>
                            <input type="text" id="proveedor" 
                                   class="input-field w-full px-4 py-3 rounded-lg bg-gray-100" 
                                   placeholder="Se cargará automáticamente"
                                   readonly>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descripción del Artículo</label>
                            <input type="text" id="descripcion" 
                                   class="input-field w-full px-4 py-3 rounded-lg bg-gray-100" 
                                   placeholder="Se cargará automáticamente"
                                   readonly>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Inventario en Reportería</label>
                            <input type="number" id="inventarioReporteria" 
                                   class="input-field w-full px-4 py-3 rounded-lg bg-gray-100" 
                                   placeholder="0"
                                   readonly>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Factor de Conversión</label>
                            <input type="number" id="factorConversion" 
                                   class="input-field w-full px-4 py-3 rounded-lg bg-gray-100" 
                                   placeholder="1.0"
                                   step="0.01"
                                   readonly>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cajas / Fardos</label>
                            <input type="number" id="cajasFardos" 
                                   class="input-field w-full px-4 py-3 rounded-lg" 
                                   placeholder="0"
                                   min="0"
                                   step="1"
                                   oninput="calcularTotalUnidades()">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Unidades</label>
                            <input type="number" id="unidades" 
                                   class="input-field w-full px-4 py-3 rounded-lg" 
                                   placeholder="0"
                                   min="0"
                                   step="1"
                                   oninput="calcularTotalUnidades()">
                        </div>
                        
                        <div class="md:col-span-2">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <span class="font-semibold text-blue-800">Total Unidades:</span>
                                    <span id="totalUnidadesCalculo" class="text-xl font-bold text-blue-800">0</span>
                                </div>
                                <p class="text-sm text-blue-600 mt-1">(Cajas × Factor) + Unidades</p>
                            </div>
                        </div>
                        
                        <div class="md:col-span-2 flex justify-end space-x-4 pt-4">
                            <button type="reset" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50" onclick="limpiarFormulario()">
                                Limpiar
                            </button>
                            <button type="submit" class="btn-primary px-6 py-3 rounded-lg text-white">
                                <i class="fas fa-plus-circle mr-2"></i>
                                Agregar Artículo
                            </button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Ver Inventario Section -->
            <section id="inventario-section" class="section-content hidden">
                <div class="card p-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <h3 class="text-lg font-semibold">Inventario Actual</h3>
                        
                        <div class="flex space-x-4 mt-4 md:mt-0">
                            <div class="relative">
                                <input type="text" id="searchInventory" 
                                       class="input-field pl-10 pr-4 py-2 rounded-lg" 
                                       placeholder="Buscar artículo...">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <button id="refreshInventory" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                <i class="fas fa-sync"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="pb-3 text-left text-sm font-medium text-gray-600">Fecha</th>
                                    <th class="pb-3 text-left text-sm font-medium text-gray-600">Código</th>
                                    <th class="pb-3 text-left text-sm font-medium text-gray-600">Descripción</th>
                                    <th class="pb-3 text-left text-sm font-medium text-gray-600">Inv. Reportería</th>
                                    <th class="pb-3 text-left text-sm font-medium text-gray-600">Factor</th>
                                    <th class="pb-3 text-left text-sm font-medium text-gray-600">Cajas/Fardos</th>
                                    <th class="pb-3 text-left text-sm font-medium text-gray-600">Unidades</th>
                                    <th class="pb-3 text-left text-sm font-medium text-gray-600">Total</th>
                                    <th class="pb-3 text-left text-sm font-medium text-gray-600">Diferencia</th>
                                    <th class="pb-3 text-left text-sm font-medium text-gray-600">Validación</th>
                                    <th class="pb-3 text-left text-sm font-medium text-gray-600">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody">
                                <tr>
                                    <td colspan="11" class="py-8 text-center text-gray-500">
                                        <i class="fas fa-inbox text-3xl mb-2"></i>
                                        <p>No hay artículos en el inventario</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Exportar CSV Section -->
            <section id="exportar-section" class="section-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-6">Exportar Inventario a CSV</h3>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Campos a Exportar</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <label class="flex items-center">
                                        <input type="checkbox" class="mr-2" name="exportFields" value="fecha" checked>
                                        Fecha
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="mr-2" name="exportFields" value="codigo" checked>
                                        Código
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="mr-2" name="exportFields" value="proveedor" checked>
                                        Proveedor
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="mr-2" name="exportFields" value="descripcion" checked>
                                        Descripción
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="mr-2" name="exportFields" value="inventarioReporteria" checked>
                                        Inv. Reportería
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="mr-2" name="exportFields" value="factorConversion" checked>
                                        Factor Conversión
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="mr-2" name="exportFields" value="cajasFardos" checked>
                                        Cajas/Fardos
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="mr-2" name="exportFields" value="unidades" checked>
                                        Unidades
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="mr-2" name="exportFields" value="total" checked>
                                        Total
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="mr-2" name="exportFields" value="diferencia" checked>
                                        Diferencia
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="mr-2" name="exportFields" value="validacion" checked>
                                        Validación
                                    </label>
                                </div>
                            </div>
                            
                            <button id="exportCSV" class="btn-primary w-full py-3 rounded-lg text-white">
                                <i class="fas fa-file-export mr-2"></i>
                                Exportar a CSV
                            </button>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Información de Exportación</h3>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex">
                                <i class="fas fa-info-circle text-blue-500 mr-3 mt-1"></i>
                                <div>
                                    <p class="text-sm text-blue-800">
                                        <strong>Formato CSV:</strong> El archivo se generará sin apóstrofes y con codificación UTF-8 para 
                                        garantizar la compatibilidad con Excel y otros programas de hojas de cálculo.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Importar Inventario Section -->
            <section id="importar-inventario-section" class="section-content hidden">
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-6">Importar Inventario</h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Carga - Inventario Teórico</label>
                            <input type="file" id="importInventoryFile" 
                                   class="input-field w-full px-4 py-3 rounded-lg" 
                                   accept=".csv"
                                   onchange="previewInventoryFile(this)">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Formato esperado</label>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <p class="text-sm text-gray-600">Fecha,Proveedor,Codigo,Descripcion,Inventario Reporteria,Factor</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="inventoryPreview" class="mt-6 bg-gray-50 p-4 rounded-lg hidden">
                        <h4 class="font-semibold mb-3">Vista previa del archivo</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead id="inventoryPreviewHead"></thead>
                                <tbody id="inventoryPreviewBody"></tbody>
                            </table>
                        </div>
                        
                        <button id="confirmImportInventory" class="btn-primary mt-4 px-6 py-2 rounded-lg text-white" disabled>
                            <i class="fas fa-upload mr-2"></i>
                            Confirmar Importación
                        </button>
                    </div>
                </div>
            </section>

            <!-- Importar Códigos Section -->
            <section id="importar-codigos-section" class="section-content hidden">
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-6">Importar Base de Códigos</h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cargar - Base de Códigos</label>
                            <input type="file" id="importCodesFile" 
                                   class="input-field w-full px-4 py-3 rounded-lg" 
                                   accept=".csv"
                                   onchange="previewCodesFile(this)">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Formato esperado</label>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <p class="text-sm text-gray-600">Codigo,Descripcion,Proveedor,Factor,Codigo de Barra</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="codesPreview" class="mt-6 bg-gray-50 p-4 rounded-lg hidden">
                        <h4 class="font-semibold mb-3">Vista previa del archivo</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead id="codesPreviewHead"></thead>
                                <tbody id="codesPreviewBody"></tbody>
                            </table>
                        </div>
                        
                        <button id="confirmImportCodes" class="btn-primary mt-4 px-6 py-2 rounded-lg text-white" enable>
                            <i class="fas fa-upload mr-2"></i>
                            Confirmar Importación
                        </button>
                    </div>
                </div>
            </section>

            <!-- Gestión de Usuarios Section -->
            <section id="usuarios-section" class="section-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-6">Gestión de Usuarios</h3>
                        
                        <div class="overflow-x-auto mb-6">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-gray-200">
                                        <th class="pb-3 text-left text-sm font-medium text-gray-600">Usuario</th>
                                        <th class="pb-3 text-left text-sm font-medium text-gray-600">Email</th>
                                        <th class="pb-3 text-left text-sm font-medium text-gray-600">Rol</th>
                                        <th class="pb-3 text-left text-sm font-medium text-gray-600">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <tr>
                                        <td colspan="4" class="py-8 text-center text-gray-500">
                                            <i class="fas fa-users text-3xl mb-2"></i>
                                            <p>Cargando usuarios...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-6" id="userFormTitle">Crear Nuevo Usuario</h3>
                        
                        <form id="userForm" class="space-y-4">
                            <input type="hidden" id="userId">
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de Usuario *</label>
                                <input type="text" id="userUsername" 
                                       class="input-field w-full px-4 py-3 rounded-lg" 
                                       placeholder="nombre.usuario"
                                       required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                <input type="email" id="userEmail" 
                                       class="input-field w-full px-4 py-3 rounded-lg" 
                                       placeholder="usuario@empresa.com"
                                       required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Contraseña *</label>
                                <input type="password" id="userPassword" 
                                       class="input-field w-full px-4 py-3 rounded-lg" 
                                       placeholder="••••••••"
                                       required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Confirmar Contraseña *</label>
                                <input type="password" id="userConfirmPassword" 
                                       class="input-field w-full px-4 py-3 rounded-lg" 
                                       placeholder="••••••••"
                                       required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Rol *</label>
                                <select id="userRole" class="input-field w-full px-4 py-3 rounded-lg">
                                    <option value="user">Usuario</option>
                                    <option value="admin">Administrador</option>
                                </select>
                            </div>
                            
                            <div class="flex space-x-4 pt-4">
                                <button type="reset" class="flex-1 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn-primary flex-1 py-3 rounded-lg text-white">
                                    <i class="fas fa-save mr-2"></i>
                                    Guardar Usuario
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="notification hidden">
        <div class="bg-white rounded-lg shadow-lg p-4 max-w-sm">
            <div class="flex items-start">
                <div id="notificationIcon" class="mr-3 mt-0.5"></div>
                <div class="flex-1">
                    <h4 id="notificationTitle" class="font-semibold"></h4>
                    <p id="notificationMessage" class="text-sm text-gray-600 mt-1"></p>
                </div>
                <button id="closeNotification" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===== VARIABLES GLOBALES =====
        let currentUser = null;
        let scannerActive = false;
        let baseDatosArticulos = JSON.parse(localStorage.getItem('baseDatosArticulos') || '[]');
        let baseDatosInventario = JSON.parse(localStorage.getItem('baseDatosInventario') || '[]');

        // ===== INICIALIZACIÓN =====
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticación
            const userData = sessionStorage.getItem('currentUser');
            if (!userData) {
                window.location.href = 'index.html';
                return;
            }
            
            currentUser = JSON.parse(userData);
            document.getElementById('currentUserName').textContent = currentUser.username;
            
            // Inicializar navegación
            initNavigation();
            
            // Cargar datos iniciales
            loadDashboardData();
            loadInventory();
            initUsers(); // Initialize user management
            
            // Configurar formulario de artículo
            document.getElementById('articuloForm').addEventListener('submit', function(e) {
                e.preventDefault();
                agregarArticulo();
            });
            
            // Configurar exportación CSV
            document.getElementById('exportCSV').addEventListener('click', exportToCSV);

            // Set current date for inventory
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months start at 0!
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('fechaInventario').value = `${yyyy}-${mm}-${dd}`;

            // Scanner buttons
            document.getElementById('startScannerBtn').addEventListener('click', startScanner);
            document.getElementById('stopScannerBtn').addEventListener('click', stopScanner);

            // Import buttons
            document.getElementById('confirmImportInventory').addEventListener('click', importInventory);
            document.getElementById('confirmImportCodes').addEventListener('click', importCodes);
        });

        // ===== NAVEGACIÓN =====
        function initNavigation() {
            // Toggle sidebar en mobile
            document.getElementById('menuToggle').addEventListener('click', function() {
                document.querySelector('.sidebar').classList.add('open');
                document.getElementById('mobileOverlay').classList.add('open');
            });
            
            document.getElementById('closeSidebar').addEventListener('click', function() {
                document.querySelector('.sidebar').classList.remove('open');
                document.getElementById('mobileOverlay').classList.remove('open');
            });
            
            document.getElementById('mobileOverlay').addEventListener('click', function() {
                document.querySelector('.sidebar').classList.remove('open');
                this.classList.remove('open');
            });
            
            // Navegación entre secciones
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Actualizar navegación activa
                    document.querySelectorAll('.nav-item').forEach(nav => {
                        nav.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Ocultar todas las secciones
                    document.querySelectorAll('.section-content').forEach(section => {
                        section.classList.add('hidden');
                    });
                    
                    // Mostrar sección correspondiente
                    const sectionId = this.getAttribute('data-section') + '-section';
                    document.getElementById(sectionId).classList.remove('hidden');
                    
                    // Actualizar título
                    const sectionTitles = {
                        'dashboard': 'Dashboard',
                        'inventario-diario': 'Inventario Diario',
                        'inventario': 'Inventario',
                        'exportar': 'Exportar CSV',
                        'importar-inventario': 'Importar Inventario',
                        'importar-codigos': 'Importar Base de Datos',
                        'usuarios': 'Gestión de Usuarios'
                    };
                    document.getElementById('currentSectionTitle').textContent = sectionTitles[this.getAttribute('data-section')];
                    
                    // Cerrar sidebar en mobile
                    if (window.innerWidth < 768) {
                        document.querySelector('.sidebar').classList.remove('open');
                        document.getElementById('mobileOverlay').classList.remove('open');
                    }

                    // Specific actions for sections
                    if (this.getAttribute('data-section') === 'inventario') {
                        loadInventory(); // Reload inventory when viewing
                    } else if (this.getAttribute('data-section') === 'usuarios') {
                        loadUsers(); // Reload users when viewing
                    }
                });
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', function() {
                sessionStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            });
        }

        // ===== DASHBOARD =====
        function loadDashboardData() {
            const inventario = JSON.parse(localStorage.getItem('inventario') || '[]');
            
            // Actualizar estadísticas
            document.getElementById('totalArticulos').textContent = inventario.length;
            
            const totalUnidades = inventario.reduce((sum, item) => {
                const total = (item.cajasFardos * item.factorConversion) + item.unidades;
                return sum + total;
            }, 0);
            document.getElementById('totalUnidadesDashboard').textContent = totalUnidades.toLocaleString();
            
            const proveedoresUnicos = new Set(inventario.map(item => item.proveedor)).size;
            document.getElementById('totalProveedores').textContent = proveedoresUnicos;
            
            if (inventario.length > 0) {
                const lastUpdate = new Date(Math.max(...inventario.map(item => new Date(item.timestamp))));
                document.getElementById('ultimaActualizacion').textContent = 
                    lastUpdate.toLocaleDateString() + ' ' + lastUpdate.toLocaleTimeString();
            }
        }

        // ===== INVENTARIO DIARIO (AGREGAR ARTÍCULO Y ESCANEAR) =====
        function cargarDatosArticulo(codigo) {
            const articulo = baseDatosArticulos.find(item => item.codigo === codigo);
            
            if (articulo) {
                document.getElementById('proveedor').value = articulo.proveedor || '';
                document.getElementById('descripcion').value = articulo.descripcion || '';
                document.getElementById('inventarioReporteria').value = articulo.inventarioReporteria || 0;
                document.getElementById('factorConversion').value = articulo.factorConversion || 1;
                
                // Buscar en inventario existente
                const inventario = JSON.parse(localStorage.getItem('inventario') || '[]');
                const existencia = inventario.find(item => item.codigo === codigo);
                
                if (existencia) {
                    document.getElementById('cajasFardos').value = existencia.cajasFardos || 0;
                    document.getElementById('unidades').value = existencia.unidades || 0;
                    document.getElementById('fechaInventario').value = existencia.fecha || document.getElementById('fechaInventario').value;
                }
                
                calcularTotalUnidades();
                showNotification('Éxito', 'Datos del artículo cargados correctamente', 'success');
            } else {
                showNotification('Advertencia', 'Artículo no encontrado en la base de datos. Por favor, ingrese los datos manualmente o importe la base de códigos.', 'warning');
                // Clear fields if not found, except code
                document.getElementById('proveedor').value = '';
                document.getElementById('descripcion').value = '';
                document.getElementById('inventarioReporteria').value = 0;
                document.getElementById('factorConversion').value = 1;
                document.getElementById('cajasFardos').value = 0;
                document.getElementById('unidades').value = 0;
                calcularTotalUnidades();
            }
        }

        function calcularTotalUnidades() {
            const cajas = parseFloat(document.getElementById('cajasFardos').value) || 0;
            const factor = parseFloat(document.getElementById('factorConversion').value) || 1;
            const unidades = parseFloat(document.getElementById('unidades').value) || 0;
            
            const total = (cajas * factor) + unidades;
            document.getElementById('totalUnidadesCalculo').textContent = total.toFixed(2);
        }

        function limpiarFormulario() {
            document.getElementById('codigoArticulo').value = '';
            document.getElementById('proveedor').value = '';
            document.getElementById('descripcion').value = '';
            document.getElementById('inventarioReporteria').value = '';
            document.getElementById('factorConversion').value = '';
            document.getElementById('cajasFardos').value = '';
            document.getElementById('unidades').value = '';
            document.getElementById('totalUnidadesCalculo').textContent = '0';
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('fechaInventario').value = `${yyyy}-${mm}-${dd}`;
        }

        function agregarArticulo() {
            const fecha = document.getElementById('fechaInventario').value;
            const codigo = document.getElementById('codigoArticulo').value;
            const cajas = parseFloat(document.getElementById('cajasFardos').value) || 0;
            const unidades = parseFloat(document.getElementById('unidades').value) || 0;
            const proveedor = document.getElementById('proveedor').value;
            const descripcion = document.getElementById('descripcion').value;
            const inventarioReporteria = parseFloat(document.getElementById('inventarioReporteria').value) || 0;
            const factorConversion = parseFloat(document.getElementById('factorConversion').value) || 1;
            
            if (!codigo || !fecha) {
                showNotification('Error', 'El código del artículo y la fecha son requeridos', 'error');
                return;
            }
            
            // Check if article exists in baseDatosArticulos, if not, allow adding with provided data
            let articuloBase = baseDatosArticulos.find(item => item.codigo === codigo);
            if (!articuloBase) {
                // If not found, create a temporary base article from current form data
                articuloBase = {
                    codigo: codigo,
                    descripcion: descripcion,
                    proveedor: proveedor,
                    inventarioReporteria: inventarioReporteria,
                    factorConversion: factorConversion
                };
                // Optionally, add this new article to baseDatosArticulos for future use
                // baseDatosArticulos.push(articuloBase);
                // localStorage.setItem('baseDatosArticulos', JSON.stringify(baseDatosArticulos));
            }
            
            const inventario = JSON.parse(localStorage.getItem('inventario') || '[]');
            const index = inventario.findIndex(item => item.codigo === codigo);
            
            const articulo = {
                fecha: fecha,
                ...articuloBase, // Use data from baseDatosArticulos or form
                cajasFardos: cajas,
                unidades: unidades,
                timestamp: new Date().toISOString()
            };
            
            if (index !== -1) {
                inventario[index] = articulo;
            } else {
                inventario.push(articulo);
            }
            
            localStorage.setItem('inventario', JSON.stringify(inventario));
            limpiarFormulario();
            showNotification('Éxito', 'Artículo agregado/actualizado correctamente', 'success');
            loadDashboardData();
            loadInventory(); // Refresh inventory table
        }

        // Barcode Scanner Functions
        function startScanner() {
            if (scannerActive) return;

            const scannerArea = document.getElementById('scanner-area');
            scannerArea.classList.remove('hidden');
            document.getElementById('startScannerBtn').classList.add('hidden');

            Quagga.init({
                inputStream : {
                    name : "Live",
                    type : "LiveStream",
                    target: document.querySelector('#scanner'),
                    constraints: {
                        facingMode: "environment" // or "user" for front camera
                    }
                },
                decoder : {
                    readers : ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "code_39_vin_reader", "codabar_reader", "upc_reader", "upc_e_reader", "i2of5_reader", "2of5_reader", "code_93_reader", "code_32_reader", "databar_reader", "databar_expanded_reader", "qr_code_reader"]
                }
            }, function(err) {
                if (err) {
                    console.log(err);
                    showNotification('Error', 'No se pudo iniciar el escáner: ' + err.message, 'error');
                    scannerArea.classList.add('hidden');
                    document.getElementById('startScannerBtn').classList.remove('hidden');
                    return
                }
                console.log("Initialization finished. Ready to start");
                Quagga.start();
                scannerActive = true;
            });

            Quagga.onDetected(function(result) {
                const code = result.codeResult.code;
                document.getElementById('codigoArticulo').value = code;
                cargarDatosArticulo(code);
                stopScanner();
                showNotification('Escaneo Exitoso', `Código detectado: ${code}`, 'success');
            });
        }

        function stopScanner() {
            if (!scannerActive) return;
            Quagga.stop();
            scannerActive = false;
            document.getElementById('scanner-area').classList.add('hidden');
            document.getElementById('startScannerBtn').classList.remove('hidden');
        }

        function importarReporteria() {
            const archivo = document.getElementById("archivoReporteria").files[0];
            if (!archivo) {
            alert("Por favor selecciona un archivo Excel.");
            return;
    }

    const lector = new FileReader();
        lector.onload = function(e) {
        const datos = new Uint8Array(e.target.result);
        const libro = XLSX.read(datos, { type: "array" });

        // Asumimos que los datos están en la primera hoja
        const hoja = libro.Sheets[libro.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(hoja, { defval: "" });

        // Construir diccionario por código de artículo
        datosReporteria = {};
        json.forEach(fila => {
            const codArt = fila["Cod Art"];
            const descripcion = fila["Cod Descrip"];
            const cantidad = fila["Cantidad"];
            if (codArt && cantidad !== "") {
                datosReporteria[String(codArt).trim()] = {
                    descripcion: descripcion,
                    cantidad: parseFloat(cantidad)
                };
            }
        });

        alert("Archivo de Reportería importado correctamente.");
        console.log("Datos de Reportería:", datosReporteria);
    };
    lector.readAsArrayBuffer(archivo);
}

        // ===== VER INVENTARIO =====
        function loadInventory() {
            const inventario = JSON.parse(localStorage.getItem('inventario') || '[]');
            const tbody = document.getElementById('inventoryTableBody');
            
            if (inventario.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="py-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-3xl mb-2"></i>
                            <p>No hay artículos en el inventario</p>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = inventario.map(item => {
                    const total = (item.cajasFardos * item.factorConversion) + item.unidades;
                    const diferencia = item.inventarioReporteria - total;
                    let validacion = '';

                    if (diferencia === 0) {
                        validacion = 'OK';
                    } else if (diferencia < 0) {
                        validacion = 'VAL+'; // Total > Inv. Reportería
                    } else {
                        validacion = 'VAL-'; // Inv. Reportería > Total
                    }
                    
                    return `
                        <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="py-4 px-4 text-sm">${item.fecha || 'N/A'}</td>
                            <td class="py-4 px-4 font-mono text-sm">${item.codigo}</td>
                            <td class="py-4 px-4 max-w-xs">${item.descripcion}</td>
                            <td class="py-4 px-4 text-center">${item.inventarioReporteria}</td>
                            <td class="py-4 px-4 text-center">${item.factorConversion}</td>
                            <td class="py-4 px-4 text-center">${item.cajasFardos || 0}</td>
                            <td class="py-4 px-4 text-center">${item.unidades}</td>
                            <td class="py-4 px-4 text-center font-bold">${total.toFixed(2)}</td>
                            <td class="py-4 px-4 text-center">${diferencia.toFixed(2)}</td>
                            <td class="py-4 px-4 text-center">
                                <span class="px-2 py-1 rounded-full text-xs ${
                                    validacion === 'OK' ? 'bg-green-100 text-green-800' :
                                    validacion === 'VAL+' ? 'bg-blue-100 text-blue-800' :
                                    'bg-red-100 text-red-800'
                                }">
                                    ${validacion}
                                </span>
                            </td>
                            <td class="py-4 px-4">
                                <div class="flex space-x-2 justify-center">
                                    <button class="text-blue-600 hover:text-blue-800" onclick="editarArticulo('${item.codigo}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="text-red-600 hover:text-red-800" onclick="eliminarArticulo('${item.codigo}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        }

        function editarArticulo(codigo) {
            const inventario = JSON.parse(localStorage.getItem('inventario') || '[]');
            const articulo = inventario.find(item => item.codigo === codigo);
            
            if (articulo) {
                document.getElementById('fechaInventario').value = articulo.fecha;
                document.getElementById('codigoArticulo').value = articulo.codigo;
                document.getElementById('proveedor').value = articulo.proveedor;
                document.getElementById('descripcion').value = articulo.descripcion;
                document.getElementById('inventarioReporteria').value = articulo.inventarioReporteria;
                document.getElementById('factorConversion').value = articulo.factorConversion;
                document.getElementById('cajasFardos').value = articulo.cajasFardos || 0;
                document.getElementById('unidades').value = articulo.unidades;
                
                calcularTotalUnidades();
                
                // Cambiar a la sección de inventario diario
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                document.querySelector('[data-section="inventario-diario"]').classList.add('active');
                document.querySelectorAll('.section-content').forEach(section => section.classList.add('hidden'));
                document.getElementById('inventario-diario-section').classList.remove('hidden');
                document.getElementById('currentSectionTitle').textContent = 'Editar Artículo de Inventario';
                
                window.scrollTo(0, 0);
            }
        }

        function eliminarArticulo(codigo) {
            if (confirm(`¿Estás seguro de eliminar el artículo ${codigo}?`)) {
                let inventario = JSON.parse(localStorage.getItem('inventario') || '[]');
                inventario = inventario.filter(item => item.codigo !== codigo);
                localStorage.setItem('inventario', JSON.stringify(inventario));
                
                loadInventory();
                loadDashboardData();
                showNotification('Éxito', 'Artículo eliminado correctamente', 'success');
            }
        }

        // ===== EXPORTAR CSV =====
        function exportToCSV() {
            const inventario = JSON.parse(localStorage.getItem('inventario') || '[]');
            
            if (inventario.length === 0) {
                showNotification('Advertencia', 'No hay datos para exportar', 'warning');
                return;
            }
            
            const selectedFields = Array.from(document.querySelectorAll('input[name="exportFields"]:checked'))
                                        .map(checkbox => checkbox.value);

            const headersMap = {
                fecha: 'Fecha',
                codigo: 'Codigo',
                descripcion: 'Descripcion',
                proveedor: 'Proveedor',
                inventarioReporteria: 'Inventario Reporteria',
                factorConversion: 'Factor',
                cajasFardos: 'Cajas/Fardos',
                unidades: 'Unidades',
                total: 'Total',
                diferencia: 'Diferencia',
                validacion: 'Validacion'
            };

            const headers = selectedFields.map(field => headersMap[field]);
            
            const csvContent = inventario.map(item => {
                const total = (item.cajasFardos * item.factorConversion) + item.unidades;
                const diferencia = item.inventarioReporteria - total;
                let validacion = '';

                if (diferencia === 0) {
                    validacion = 'OK';
                } else if (diferencia < 0) {
                    validacion = 'VAL+';
                } else {
                    validacion = 'VAL-';
                }

                const rowData = {
                    fecha: item.fecha || '',
                    codigo: item.codigo,
                    descripcion: item.descripcion,
                    proveedor: item.proveedor,
                    inventarioReporteria: item.inventarioReporteria,
                    factorConversion: item.factorConversion,
                    cajasFardos: item.cajasFardos || 0,
                    unidades: item.unidades,
                    total: total.toFixed(2),
                    diferencia: diferencia.toFixed(2),
                    validacion: validacion
                };

                return selectedFields.map(field => `"${rowData[field]}"`).join(',');
            }).join('\n');
            
            const csv = headers.join(',') + '\n' + csvContent;
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `inventario_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Éxito', 'Archivo CSV exportado correctamente', 'success');
        }

        // ===== IMPORTAR DATOS =====
        function previewInventoryFile(input) {
            const file = input.files[0];
            const previewDiv = document.getElementById('inventoryPreview');
            const previewHead = document.getElementById('inventoryPreviewHead');
            const previewBody = document.getElementById('inventoryPreviewBody');
            const confirmBtn = document.getElementById('confirmImportInventory');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim() !== '');
                    
                    if (lines.length > 0) {
                        const headers = lines[0].split(',');
                        previewHead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
                        
                        let bodyHtml = '';
                        for (let i = 1; i < Math.min(lines.length, 6); i++) { // Show max 5 rows
                            const cells = lines[i].split(',');
                            bodyHtml += `<tr>${cells.map(c => `<td>${c}</td>`).join('')}</tr>`;
                        }
                        previewBody.innerHTML = bodyHtml;
                        previewDiv.classList.remove('hidden');
                        confirmBtn.disabled = false;
                    } else {
                        previewDiv.classList.add('hidden');
                        confirmBtn.disabled = true;
                        showNotification('Advertencia', 'El archivo CSV está vacío.', 'warning');
                    }
                };
                reader.readAsText(file);
            } else {
                previewDiv.classList.add('hidden');
                confirmBtn.disabled = true;
            }
        }

        function importInventory() {
            const fileInput = document.getElementById('importInventoryFile');
            const file = fileInput.files[0];

            if (!file) {
                showNotification('Error', 'Por favor, seleccione un archivo para importar.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim() !== '');

                if (lines.length < 2) {
                    showNotification('Error', 'El archivo CSV no contiene datos válidos (se espera al menos una fila de encabezado y una de datos).', 'error');
                    return;
                }

                const headers = lines[0].split(',').map(h => h.trim());
                const expectedHeaders = ['Fecha', 'Proveedor', 'Codigo', 'Descripcion', 'Inventario Reporteria', 'Factor'];

                // Basic header validation
                if (headers.length !== expectedHeaders.length || !headers.every((h, i) => h === expectedHeaders[i])) {
                    showNotification('Error', 'El formato del encabezado del archivo CSV no es el esperado. Formato esperado: ' + expectedHeaders.join(','), 'error');
                    return;
                }

                let importedCount = 0;
                let updatedCount = 0;
                let inventario = JSON.parse(localStorage.getItem('inventario') || '[]');

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length === headers.length) {
                        const item = {
                            fecha: values[0].trim(),
                            proveedor: values[1].trim(),
                            codigo: values[2].trim(),
                            descripcion: values[3].trim(),
                            inventarioReporteria: parseFloat(values[4].trim()) || 0,
                            factorConversion: parseFloat(values[5].trim()) || 1,
                            cajasFardos: 0, // Default for imported inventory
                            unidades: 0,    // Default for imported inventory
                            timestamp: new Date().toISOString()
                        };

                        const existingIndex = inventario.findIndex(invItem => invItem.codigo === item.codigo);
                        if (existingIndex !== -1) {
                            // Update existing item, preserving cajasFardos and unidades if they exist
                            inventario[existingIndex] = {
                                ...inventario[existingIndex], // Keep existing cajasFardos, unidades if not provided by import
                                ...item, // Override with imported data
                                cajasFardos: inventario[existingIndex].cajasFardos || 0,
                                unidades: inventario[existingIndex].unidades || 0,
                            };
                            updatedCount++;
                        } else {
                            inventario.push(item);
                            importedCount++;
                        }
                    }
                }

                localStorage.setItem('inventario', JSON.stringify(inventario));
                showNotification('Importación Completa', `Inventario importado: ${importedCount} nuevos, ${updatedCount} actualizados.`, 'success');
                
                // Clear preview and disable button
                document.getElementById('inventoryPreview').classList.add('hidden');
                document.getElementById('confirmImportInventory').disabled = true;
                fileInput.value = ''; // Clear selected file
                loadInventory();
                loadDashboardData();
            };
            reader.readAsText(file);
        }

        function previewCodesFile(input) {
            const file = input.files[0];
            const previewDiv = document.getElementById('codesPreview');
            const previewHead = document.getElementById('codesPreviewHead');
            const previewBody = document.getElementById('codesPreviewBody');
            const confirmBtn = document.getElementById('confirmImportCodes');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim() !== '');
                    
                    if (lines.length > 0) {
                        const headers = lines[0].split(',');
                        previewHead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
                        
                        let bodyHtml = '';
                        for (let i = 1; i < Math.min(lines.length, 6); i++) { // Show max 5 rows
                            const cells = lines[i].split(',');
                            bodyHtml += `<tr>${cells.map(c => `<td>${c}</td>`).join('')}</tr>`;
                        }
                        previewBody.innerHTML = bodyHtml;
                        previewDiv.classList.remove('hidden');
                        confirmBtn.disabled = false;
                    } else {
                        previewDiv.classList.add('hidden');
                        confirmBtn.disabled = true;
                        showNotification('Advertencia', 'El archivo CSV está vacío.', 'warning');
                    }
                };
                reader.readAsText(file);
            } else {
                previewDiv.classList.add('hidden');
                confirmBtn.disabled = true;
            }
        }

        function importCodes() {
            const fileInput = document.getElementById('importCodesFile');
            const file = fileInput.files[0];

            if (!file) {
                showNotification('Error', 'Por favor, seleccione un archivo para importar.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim() !== '');

                if (lines.length < 2) {
                    showNotification('Error', 'El archivo CSV no contiene datos válidos (se espera al menos una fila de encabezado y una de datos).', 'error');
                    return;
                }

                const headers = lines[0].split(',').map(h => h.trim());
                const expectedHeaders = ['Codigo', 'Descripcion', 'Proveedor', 'Factor', 'Codigo de Barra'];

                // Basic header validation
                if (headers.length !== expectedHeaders.length || !headers.every((h, i) => h === expectedHeaders[i])) {
                    showNotification('Error', 'El formato del encabezado del archivo CSV no es el esperado. Formato esperado: ' + expectedHeaders.join(','), 'error');
                    return;
                }

                let importedCount = 0;
                let updatedCount = 0;
                let currentBaseDatosArticulos = JSON.parse(localStorage.getItem('baseDatosArticulos') || '[]');

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length === headers.length) {
                        const item = {
                            codigo: values[0].trim(),
                            descripcion: values[1].trim(),
                            proveedor: values[2].trim(),
                            factorConversion: parseFloat(values[3].trim()) || 1,
                            codigoDeBarra: values[4].trim() // Assuming this is the barcode
                        };

                        const existingIndex = currentBaseDatosArticulos.findIndex(baseItem => baseItem.codigo === item.codigo);
                        if (existingIndex !== -1) {
                            currentBaseDatosArticulos[existingIndex] = item;
                            updatedCount++;
                        } else {
                            currentBaseDatosArticulos.push(item);
                            importedCount++;
                        }
                    }
                }

                localStorage.setItem('baseDatosArticulos', JSON.stringify(currentBaseDatosArticulos));
                baseDatosArticulos = currentBaseDatosArticulos; // Update global variable
                showNotification('Importación Completa', `Base de códigos importada: ${importedCount} nuevos, ${updatedCount} actualizados.`, 'success');
                
                // Clear preview and disable button
                document.getElementById('codesPreview').classList.add('hidden');
                document.getElementById('confirmImportCodes').disabled = true;
                fileInput.value = ''; // Clear selected file
            };
            reader.readAsText(file);
        }

        // ===== NOTIFICACIONES =====
        function showNotification(title, message, type = 'info') {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationMessage = document.getElementById('notificationMessage');
            
            let iconClass = '';
            let bgColorClass = '';
            let textColorClass = '';

            switch(type) {
                case 'success':
                    iconClass = 'fas fa-check-circle text-green-500';
                    bgColorClass = 'bg-green-100';
                    textColorClass = 'text-green-800';
                    break;
                case 'error':
                    iconClass = 'fas fa-exclamation-circle text-red-500';
                    bgColorClass = 'bg-red-100';
                    textColorClass = 'text-red-800';
                    break;
                case 'warning':
                    iconClass = 'fas fa-exclamation-triangle text-yellow-500';
                    bgColorClass = 'bg-yellow-100';
                    textColorClass = 'text-yellow-800';
                    break;
                default:
                    iconClass = 'fas fa-info-circle text-blue-500';
                    bgColorClass = 'bg-blue-100';
                    textColorClass = 'text-blue-800';
            }
            
            icon.className = iconClass;
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            
            // Apply background and text color to the notification card itself
            notification.querySelector('.bg-white').className = `rounded-lg shadow-lg p-4 max-w-sm ${bgColorClass} ${textColorClass}`;

            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
                // Reset to default white background after hiding
                notification.querySelector('.rounded-lg').className = 'bg-white rounded-lg shadow-lg p-4 max-w-sm';
            }, 5000);
        }
        
        document.getElementById('closeNotification').addEventListener('click', function() {
            document.getElementById('notification').classList.add('hidden');
            // Reset to default white background when closed manually
            document.getElementById('notification').querySelector('.rounded-lg').className = 'bg-white rounded-lg shadow-lg p-4 max-w-sm';
        });

        // ===== GESTIÓN DE USUARIOS =====
        function initUsers() {
            const form = document.getElementById('userForm');
            const formTitle = document.getElementById('userFormTitle');
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('userUsername').value;
                const email = document.getElementById('userEmail').value;
                const password = document.getElementById('userPassword').value;
                const confirmPassword = document.getElementById('userConfirmPassword').value;
                const role = document.getElementById('userRole').value;
                const userId = document.getElementById('userId').value; // This will be the original username for editing
                
                // Validaciones
                if (password !== confirmPassword) {
                    showNotification('Error', 'Las contraseñas no coinciden', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    showNotification('Error', 'La contraseña debe tener al menos 6 caracteres', 'error');
                    return;
                }
                
                let users = JSON.parse(localStorage.getItem('users') || '[]');
                
                if (userId) {
                    // Editar usuario existente
                    const userIndex = users.findIndex(u => u.username === userId);
                    if (userIndex !== -1) {
                        users[userIndex] = {
                            username: username, // Username might be changed, but we use original for lookup
                            email: email,
                            password: password, // In a real app, hash this!
                            role: role
                        };
                    }
                } else {
                    // Crear nuevo usuario
                    if (users.some(u => u.username === username)) {
                        showNotification('Error', 'El nombre de usuario ya existe', 'error');
                        return;
                    }
                    
                    users.push({
                        username: username,
                        email: email,
                        password: password, // In a real app, hash this!
                        role: role
                    });
                }
                
                localStorage.setItem('users', JSON.stringify(users));
                
                // Limpiar formulario
                form.reset();
                document.getElementById('userId').value = '';
                formTitle.textContent = 'Crear Nuevo Usuario';
                document.getElementById('userUsername').disabled = false; // Enable username field for new user
                
                // Recargar lista de usuarios
                loadUsers();
                
                showNotification('Éxito', userId ? 'Usuario actualizado' : 'Usuario creado', 'success');
            });
            
            // Cancelar edición
            form.querySelector('button[type="reset"]').addEventListener('click', function() {
                form.reset();
                document.getElementById('userId').value = '';
                formTitle.textContent = 'Crear Nuevo Usuario';
                document.getElementById('userUsername').disabled = false; // Enable username field for new user
            });

            loadUsers(); // Initial load of users when the page loads
        }
        
        function loadUsers() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="py-8 text-center text-gray-500">
                            <i class="fas fa-users text-3xl mb-2"></i>
                            <p>No hay usuarios registrados</p>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = users.map(user => `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="py-3 px-4 font-medium">${user.username}</td>
                        <td class="py-3 px-4">${user.email}</td>
                        <td class="py-3 px-4">
                            <span class="px-2 py-1 rounded-full text-xs ${
                                user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'
                            }">
                                ${user.role === 'admin' ? 'Administrador' : 'Usuario'}
                            </span>
                        </td>
                        <td class="py-3 px-4">
                            <div class="flex space-x-2">
                                <button type="button" class="text-blue-600 hover:text-blue-800 edit-user" data-username="${user.username}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${user.username !== currentUser.username ? `
                                <button type="button" class="text-red-600 hover:text-red-800 delete-user" data-username="${user.username}">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                // Agregar event listeners
                document.querySelectorAll('.edit-user').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const username = this.getAttribute('data-username');
                        editUser(username);
                    });
                });
                
                document.querySelectorAll('.delete-user').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const username = this.getAttribute('data-username');
                        deleteUser(username);
                    });
                });
            }
        }
        
        function editUser(username) {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.username === username);
            
            if (user) {
                document.getElementById('userUsername').value = user.username;
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userPassword').value = user.password; // Pre-fill password for convenience (in real app, don't do this)
                document.getElementById('userConfirmPassword').value = user.password; // Pre-fill password for convenience
                document.getElementById('userRole').value = user.role;
                document.getElementById('userId').value = user.username; // Store original username for lookup
                
                document.getElementById('userFormTitle').textContent = 'Editar Usuario';
                document.getElementById('userUsername').disabled = true; // Prevent changing username during edit
            }
        }
        
        function deleteUser(username) {
            if (confirm(`¿Estás seguro de que quieres eliminar al usuario ${username}?`)) {
                let users = JSON.parse(localStorage.getItem('users') || '[]');
                users = users.filter(u => u.username !== username);
                localStorage.setItem('users', JSON.stringify(users));
                
                loadUsers();
                showNotification('Eliminado', `Usuario ${username} eliminado`, 'success');
            }
        }


        // Inicializar base de datos de ejemplo si no existe
        if (baseDatosArticulos.length === 0) {
            baseDatosArticulos = [
                {
                    codigo: 'PROD-001',
                    descripcion: 'Laptop HP EliteBook',
                    proveedor: 'Tecnologia S.A.',
                    inventarioReporteria: 50,
                    factorConversion: 1
                },
                {
                    codigo: 'PROD-002',
                    descripcion: 'Mouse Inalámbrico',
                    proveedor: 'Perifericos Ltda.',
                    inventarioReporteria: 100,
                    factorConversion: 1
                },
                {
                    codigo: 'PROD-003',
                    descripcion: 'Teclado Mecánico',
                    proveedor: 'Perifericos Ltda.',
                    inventarioReporteria: 75,
                    factorConversion: 1
                },
                {
                    codigo: 'PROD-004',
                    descripcion: 'Monitor Curvo 27"',
                    proveedor: 'Tecnologia S.A.',
                    inventarioReporteria: 30,
                    factorConversion: 1
                },
                {
                    codigo: 'PROD-005',
                    descripcion: 'Impresora Multifuncional',
                    proveedor: 'Oficina Total',
                    inventarioReporteria: 20,
                    factorConversion: 1
                },
                {
                    codigo: 'PROD-006',
                    descripcion: 'Resma de Papel A4',
                    proveedor: 'Oficina Total',
                    inventarioReporteria: 200,
                    factorConversion: 5 // 5 paquetes por caja/fardo
                }
            ];
            localStorage.setItem('baseDatosArticulos', JSON.stringify(baseDatosArticulos));
        }

        // Initialize a default admin user if no users exist
        if (!localStorage.getItem('users')) {
            const defaultUsers = [
                {
                    username: 'admin',
                    email: 'admin@example.com',
                    password: 'adminpassword', // In a real application, hash this password!
                    role: 'admin'
                }
            ];
            localStorage.setItem('users', JSON.stringify(defaultUsers));
        }
    </script>
</body>
</html>
